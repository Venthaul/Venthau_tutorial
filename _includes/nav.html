{%- comment -%}
  The `nav_order` values of pages affect the order in which they are shown in
  the navigation panel and in the automatically generated tables of contents.
  Sibling pages with the same `nav_order` value may be shown in any order.
  
  A `nav_order` value can be a number or a string. To avoid build failures,
  we sort numbers and strings separately. We sort numbers by their values,
  and strings lexicographically. The case-sensitivity of string sorting is
  determined by the configuration setting of `nav_sort`.
  
  Omitting the `nav_number` is equivalent to setting it to the page `title`.

  Note: To use a number as a `title`, enclose it in (single or double) quotes.
  Numbers used as `nav_order` values should not be in quotes, unless you intend
  them to be lexicographically ordered (so `"10"` comes before `"2"`, for example).
{%- endcomment -%}

{%- assign title_pages = include.pages
      | where_exp: "item", "item.title != nil" -%}
{%- assign nav_order_pages = title_pages
      | where_exp: "item", "item.nav_order != nil"  -%}
{%- assign title_order_pages = title_pages
      | where_exp: "item", "item.nav_order == nil" -%}

{%- comment -%}
  First, the array of `nav_order_pages` is divided according to the type of
  `nav_order` value.
  
  The first character of the result of `jsonify` is `"` only for strings.
  Grouping by a single character also ensures the number of groups is small.
{%- endcomment -%}

{%- assign number_order_pages = "" | split: "" -%}
{%- assign string_order_pages = title_order_pages -%}
{%- assign nav_order_groups = nav_order_pages
      | group_by_exp: "item", "item.nav_order | jsonify | slice: 0" -%}
{%- for group in nav_order_groups -%}
  {%- if group.name == '"' -%}
    {%- assign string_order_pages = string_order_pages | concat: group.items -%}
  {%- else -%}
    {%- assign number_order_pages = number_order_pages | concat: group.items -%}
  {%- endif -%}
{%- endfor -%}

{%- assign sorted_number_order_pages = number_order_pages | sort: "nav_order" -%}

{%- comment -%}
  When `string_order_pages` is empty, it is already sorted. Another simple case
  is when no pages have `nav_order` values: they are sorted by their titles.
  Otherwise, we need to group the `string_order_pages` by their `nav_order` or
  `title` values, sort the groups by those values, and concatenate the grouped
  arrays of pages.
{%- endcomment -%}

{%- if string_order_pages.size == 0 -%}

  {%- assign sorted_string_order_pages = string_order_pages -%}

{%- elsif string_order_pages.size == title_order_pages.size -%}

  {%- if site.nav_sort == 'case_insensitive' -%}
    {%- assign sorted_string_order_pages = string_order_pages | sort_natural: "title" -%}
  {%- else -%}
    {%- assign sorted_string_order_pages = string_order_pages | sort: "title" -%}
  {%- endif -%}

{%- else -%}

  {%- assign string_order_groups = string_order_pages
        | group_by_exp: "item", "item.nav_order | default: item.title" -%}
  {%- if site.nav_sort == 'case_insensitive' -%}
    {%- assign sorted_string_order_groups = string_order_groups | sort_natural: "name" -%}
  {%- else -%}
    {%- assign sorted_string_order_groups = string_order_groups | sort: "name" -%}
  {%- endif -%}
  {%- assign sorted_string_order_pages = "" | split: "" -%}
  {%- for group in sorted_string_order_groups -%}
    {%- assign sorted_string_order_pages = sorted_string_order_pages | concat: group.items -%}
  {%- endfor -%}

{%- endif -%}

{%- assign pages_list = sorted_number_order_pages | concat: sorted_string_order_pages -%}

<ul class="nav-list">
{%- for node in pages_list -%}
  {%- if node.parent == nil -%}
    {%- unless node.nav_exclude -%}
      <li class="nav-list-item{% if page.collection == include.key and page.url == node.url or page.parent == node.title or page.grand_parent == node.title %} active{% endif %}">
        {%- if node.has_children -%}
          <a href="#" class="nav-list-expander" aria-label="toggle links in {{ node.title }} category">
            <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg>
          </a>
        {%- endif -%}
        <a href="{{ node.url | relative_url }}" class="nav-list-link{% if page.url == node.url %} active{% endif %}">{{ node.title }}</a>
        {%- if node.has_children -%}
          {%- if node.child_nav_order == 'desc' -%}
            {%- assign children_list = pages_list | where: "parent", node.title | where_exp:"item", "item.grand_parent == nil" | reverse -%}
          {%- else -%}
            {%- assign children_list = pages_list | where: "parent", node.title | where_exp:"item", "item.grand_parent == nil" -%}
          {%- endif -%}
          <ul class="nav-list ">
          {%- for child in children_list -%}
            {%- unless child.nav_exclude -%}
            <li class="nav-list-item {% if page.url == child.url or page.parent == child.title %} active{% endif %}">
              {%- if child.has_children -%}
                <a href="#" class="nav-list-expander" aria-label="toggle links in {{ child.title }} category">
                  <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg>
                </a>
              {%- endif -%}
              <a href="{{ child.url | relative_url }}" class="nav-list-link{% if page.url == child.url %} active{% endif %}">{{ child.title }}</a>
              {%- if child.has_children -%}
                {%- if node.child_nav_order == 'desc' -%}
                {%- assign grand_children_list = pages_list | where: "parent", child.title | where: "grand_parent", node.title | reverse -%}
                {%- else -%}
                {%- assign grand_children_list = pages_list | where: "parent", child.title | where: "grand_parent", node.title -%}
                {%- endif -%}
                <ul class="nav-list">
                {%- for grand_child in grand_children_list -%}
                  {%- unless grand_child.nav_exclude -%}
                  <li class="nav-list-item {% if page.url == grand_child.url %} active{% endif %}">
                    <a href="{{ grand_child.url | relative_url }}" class="nav-list-link{% if page.url == grand_child.url %} active{% endif %}">{{ grand_child.title }}</a>
                  </li>
                  {%- endunless -%}
                {%- endfor -%}
                </ul>
              {%- endif -%}
            </li>
            {%- endunless -%}
          {%- endfor -%}
          </ul>
        {%- endif -%}
      </li>
    {%- endunless -%}
  {%- endif -%}
{%- endfor -%}
{%- assign nav_external_links = site.nav_external_links -%}
{%- for node in nav_external_links -%}
      <li class="nav-list-item external">
        <a href="{{ node.url | absolute_url }}" class="nav-list-link external">
          {{ node.title }}
          {% unless node.hide_icon %}<svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg>{% endunless %}
        </a>
      </li>
{%- endfor -%}
  </ul>

{%- if page.collection == include.key -%}

  {%- for node in pages_list -%}
    {%- if node.parent == nil -%}
      {%- if page.grand_parent == node.title or page.parent == node.title and page.grand_parent == nil -%}
        {%- assign first_level_url = node.url | relative_url -%}
      {%- endif -%}
      {%- if node.has_children -%}
        {%- assign children_list = pages_list | where: "parent", node.title -%}
        {%- for child in children_list -%}
          {%- if child.has_children -%}
            {%- if page.url == child.url or page.parent == child.title and page.grand_parent == child.parent -%}
              {%- assign second_level_url = child.url | relative_url -%}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}

  {% if page.has_children == true and page.has_toc != false %}
    {%- assign toc_list = pages_list | where: "parent", page.title | where: "grand_parent", page.parent -%}
  {%- endif -%}

{%- endif -%}
