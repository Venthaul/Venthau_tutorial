{%- comment -%}
  Pages with no `title` are implicitly excluded from the navigation.
  
  The `title` and `nav_order` values can be numbers or strings.
  Jekyll gives build failures when sorting on values of mixed types,
  so numbers and strings need to be sorted separately.

  Numbers are sorted by their values, and come before all strings.
  An omitted `nav_order` value is equivalent to the page's `title` value.

  The case-sensitivity of string sorting is determined by `site.nav_sort`.
{%- endcomment -%}

{%- assign titled_pages = include.pages
      | where_exp: "item", "item.title" -%}

{%- comment -%}
  Group titled pages that have explicit `nav_order` values:
{%- endcomment -%}

{%- assign nav_ordered_groups = titled_pages
      | where_exp: "item", "item.nav_order"
      | group_by: "nav_order" -%}

{%- comment -%}
  Sort the groups of pages that have numeric `nav_order` values:
{%- endcomment -%}

{%- assign sorted_number_ordered_groups = nav_ordered_groups
      | where_exp: "group", "group.name[0] == empty"
      | sort: "name" -%}

{%- comment -%}
  Group titled pages that have no `nav_order` by their `title` values,
  appending '' to convert numbers to strings:
{%- endcomment -%}

{%- assign title_ordered_groups = titled_pages
      | where_exp: "item", "item.nav_order == nil"
      | group_by_exp: "item", "item.title | append: ''" -%}

{%- comment -%}
  Concatenate the groups of pages that have string `nav_order` values
  with the groups of pages that have no `nav_order` values:
{%- endcomment -%}

{%- assign string_ordered_groups = nav_ordered_groups
      | where_exp: "group", "group.name[0] != empty"
      | concat: title_ordered_groups -%}

{%- comment -%}
  Sort the groups of pages with (explicit or implicit) string `nav_order` values,
  taking account of the site case-insensitivity setting:
{%- endcomment -%}

{%- if site.nav_sort == 'case_insensitive' -%}
  {%- assign sorted_string_ordered_groups = string_ordered_groups
        | sort_natural: "name" -%}
{%- else -%}
  {%- assign sorted_string_ordered_groups = string_ordered_groups
        | sort:"name" -%}
{%- endif -%}

{%- assign groups_list = sorted_number_ordered_groups
      | concat: sorted_string_ordered_groups -%}

{%- comment -%}
  We needed to group pages because Jekyll-Liquid lacks filters for sorting pages
  by expression values. After sorting, the grouping is irrelevant: we only need
  the sorted pages-list to generate the navigation links.
  
  Unfortunately, the obvious way of discarding the grouping (by concatenating the
  lists of pages from each group) appears to be quadratic in the number of groups.
  For example, it can take about 35 seconds to concatenate 130 one-item groups
  using the following code:
  
  {%- assign sorted_string_ordered_pages = "" | split: "" -%}
  {%- for group in sorted_string_ordered_groups -%}
    {%- assign sorted_string_ordered_pages = sorted_string_ordered_pages
          | concat: group.items -%}
  {%- endfor -%}
  
  It is significantly more efficient (albeit it somewhat messier in the code)
  to geneate the navigation links directly from the grouped pages:
{%- endcomment -%}

<ul class="nav-list">
{%- for node_group in groups_list -%} 
  {%- for node in node_group.items -%}
    {%- if node.parent == nil -%}
      {%- unless node.nav_exclude -%}
      <li class="nav-list-item{% if page.collection == include.key and page.url == node.url or page.parent == node.title or page.grand_parent == node.title %} active{% endif %}">
        {%- if node.has_children -%}
          <a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a>
        {%- endif -%}
        <a href="{{ node.url | relative_url }}" class="nav-list-link{% if page.url == node.url %} active{% endif %}">{{ node.title }}</a>
        {%- if node.has_children -%}
          {%- assign children_list = "" | split: "" -%}
          {%- for parent_group in groups_list -%}
            {%- assign children_list = children_list | concat: 
                  parent_group.items | where: "parent", node.title
                  | where_exp:"item", "item.grand_parent == nil" -%}
          {%- endfor -%}
          {%- if node.child_nav_order == 'desc' -%}
            {%- assign children_list = children_list | reverse -%}
          {%- endif -%}
          <ul class="nav-list ">
          {%- for child in children_list -%}
            {%- unless child.nav_exclude -%}
            <li class="nav-list-item {% if page.url == child.url or page.parent == child.title %} active{% endif %}">
              {%- if child.has_children -%}
                <a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a>
              {%- endif -%}
              <a href="{{ child.url | relative_url }}" class="nav-list-link{% if page.url == child.url %} active{% endif %}">{{ child.title }}</a>
              {%- if child.has_children -%}
                {%- assign grandchildren_list = "" | split: "" -%}
                {%- for grandparent_group in groups_list -%}
                  {%- assign grandchildren_list = grandchildren_list | concat: 
                        grandparent_group.items | where: "parent", child.title
                        | where: "grand_parent", node.title -%}
                {%- endfor -%}
                {%- if node.child_nav_order == 'desc' -%}
                  {%- assign grandchildren_list = grandchildren_list | reverse -%}
                {%- endif -%}
                <ul class="nav-list">
                {%- for grandchild in grandchildren_list -%}
                  {%- unless grandchild.nav_exclude -%}
                  <li class="nav-list-item {% if page.url == grandchild.url %} active{% endif %}">
                    <a href="{{ grandchild.url | relative_url }}" class="nav-list-link{% if page.url == grandchild.url %} active{% endif %}">{{ grandchild.title }}</a>
                  </li>
                  {%- endunless -%}
                {%- endfor -%}
                </ul>
              {%- endif -%}
            </li>
            {%- endunless -%}
          {%- endfor -%}
          </ul>
        {%- endif -%}
      </li>
      {%- endunless -%}
    {%- endif -%}
  {%- endfor -%}
{%- endfor -%}

{%- assign nav_external_links = site.nav_external_links -%}
{%- for node in nav_external_links -%}
  <li class="nav-list-item external">
    <a href="{{ node.url | absolute_url }}" class="nav-list-link external">
      {{ node.title }}
      {% unless node.hide_icon %}<svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg>{% endunless %}
    </a>
  </li>
{%- endfor -%}
</ul>

{%- if page.collection == include.key -%}

  {%- for node_group in groups_list -%}
    {%- for node in node_group.items -%}
    {%- if node.parent == nil -%}
      {%- if page.grand_parent == node.title or page.parent == node.title and page.grand_parent == nil -%}
        {%- assign first_level_url = node.url | relative_url -%}
      {%- endif -%}
      {%- if node.has_children -%}
        {%- assign children_list = "" | split: "" -%}
        {%- for parent_group in groups_list -%}
          {%- assign children_list = children_list | concat: 
                parent_group.items | where: "parent", node.title -%}
        {%- endfor -%}
        {%- if node.child_nav_order == 'desc' -%}
          {%- assign children_list = children_list | reverse -%}
        {%- endif -%}
        {%- for child in children_list -%}
          {%- if child.has_children -%}
            {%- if page.url == child.url or page.parent == child.title and page.grand_parent == child.parent -%}
              {%- assign second_level_url = child.url | relative_url -%}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
    {%- endif -%}
    {%- endfor -%}
  {%- endfor -%}

  {% if page.has_children == true and page.has_toc != false %}
    {%- assign toc_list = "" | split: "" -%}
    {%- for parent_group in groups_list -%}
      {%- assign toc_list = toc_list | concat: 
            parent_group.items | where: "parent", page.title
            | where: "grand_parent", page.parent -%}
    {%- endfor -%}
    {%- if node.child_nav_order == 'desc' -%}
      {%- assign toc_list = toc_list | reverse -%}
    {%- endif -%}
  {%- endif -%}

{%- endif -%}
