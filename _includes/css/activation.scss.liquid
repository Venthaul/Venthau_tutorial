{%- comment -%}
  Include as: {%- include css/activation.scss.liquid -%}
  Depends on: page, site.
  Results in: page-dependent (non-nested) CSS rules for inclusion in a head style element,
    which needs to be disabled when JS is enabled.
  Includes:
    sorted_pages.html.
  Overwrites: 
    activation_no_nav_link,
    nav_list, nav_list_item, nav_list_link, nav_category_list,
    site_nav, nav_list_link_prefix, nav_list_item_separateds, 
    nav_index0, nav_index1, nav_index2, nav_index3,
    activation_collection_prefix, activation_other_collection_prefix.
  Should not be cached, because it depends on page.
{%- endcomment -%}

{%- comment -%}
  The CSS rules in activation_no_nav_link are for use on pages excluded from the main navigation.
  - The first rule ensures that no nav-link has a background image.
  - The other two rules ensure that all folding collections are expanded.
{%- endcomment -%}

{%- capture activation_no_nav_link %}
.site-nav ul li a {
  background-image: none;
}

{%- if site.just_the_docs.collections %}
.site-nav > ul.nav-category-list > li > button svg {
  transform: rotate(-90deg);
}
.site-nav > ul.nav-category-list > li.nav-list-item > ul.nav-list {
  display: block;
}
{%- endif %}
{% endcapture -%}

{%- if page.title == nil or page.nav_exclude == true -%}

{{ activation_no_nav_link }}

{%- else -%}

{%- capture nav_list -%}
<ul class="nav-list">
{%- endcapture -%}

{%- capture nav_list_item -%}
<li class="nav-list-item
{%- endcapture -%}

{%- capture nav_list_link -%}
<a href="{{ page.url | relative_url }}" class="nav-list-link">
{%- endcapture -%}

{%- capture nav_category_list -%}
<ul class="nav-list nav-category-list">
{%- endcapture -%}

{%- capture site_nav -%}
{%- include_cached components/site_nav.html -%}
{%- endcapture -%}

{%- assign nav_list_link_prefix =
      site_nav | split: nav_list_link | first | append: nav_list_link -%}

{%- assign nav_list_item_separateds =
      nav_list_link_prefix | split: nav_list_item | pop -%}

{%- comment -%}
  The string before the first nav-list-item must contain a ul.nav-list tag.
  It could be for a list of ordinary pages, for external links, or for a collection.
  
  The string after a nav-list-item is non-empty, and may contain:
  - a ul.nav-list tag (when the item is the first in a list) and/or
    one or more closing ul tags (when the item is preceded by a list)
  - a div.nav-category tag and a ul.nav-list tag (when the item is the first in
    a foldable collection)
  - neither of the above (when it is not the first item in a list).
{%- endcomment %}

{%- assign nav_level = 0 -%}
{%- assign nav_index0 = 1 -%}
{%- assign nav_index1 = nil -%}
{%- assign nav_index2 = nil -%}
{%- assign nav_index3 = nil -%}

{%- for separated in nav_list_item_separateds -%}
  {%- unless separated contains nav_category_list and false -%}

    {%- if separated contains "</ul>" -%}
      {%- assign endless = separated | remove: "</ul>" -%}
      {%- assign differs = separated.size | minus: endless.size | divided_by: 5 -%}
      {% for index in (1..differs) %}
        {% case nav_level %}
          {% when 1 %}
            {%- assign nav_index1 = nil -%}
          {% when 2 %}
            {%- assign nav_index2 = nil -%}
          {% when 3 %}
            {%- assign nav_index3 = nil -%}
        {% endcase %}
        {%- assign nav_level = nav_level | minus: 1 -%}
      {%- endfor -%}
    {%- endif -%}

    {%- if separated contains nav_list -%}
      {%- assign nav_level = nav_level | plus: 1 -%}
    {%- endif -%}

    {% case nav_level %}
      {% when 0 %}
        {%- assign nav_index0 = nav_index0 | plus: 1 -%}
      {% when 1 %}
        {%- assign nav_index1 = nav_index1 | plus: 1 -%}
      {% when 2 %}
        {%- assign nav_index2 = nav_index2 | plus: 1 -%}
      {% when 3 %}
        {%- assign nav_index3 = nav_index3 | plus: 1 -%}
    {% endcase %}

  {%- endunless -%}
{%- endfor -%}

{%- comment -%}
  The generated CSS depends on the position of the current page in each level in
  the navigation.
{%- endcomment -%}

{%- if nav_index1 == nil -%}

{{ activation_no_nav_link }}

{%- else -%}

{%- if nav_index2 == nil and nav_index3 -%}

{{ activation_no_nav_link }}

{%- else -%}

{%- comment -%}
  The site-nav is:
  - an optional ul.nav-list with li.nav-list-items for non-collection top-level pages
  - an optional ul.nav-list with li.nav-list-item.externals
  - any number of just-the-docs.collections
  
  A non-foldable collection is:
  - a div.nav-category with the collection name, followed by:
  - a ul.nav-list with li.nav-list-items for its top-level pages
  
  A foldable collection is:
  - a ul.nav-list.nav-category-list with a single li.nav-list-item containing:
    - an optional button with the expander svg
    - a div.nav-category with the collection name
    - a ul.nav-list with li.nav-list-items for its top-level pages
  
  The generated CSS uses:
  - activation_collection_prefix, to select the site-nav > ul.nav-list for the page
  - activation_other_collection_prefix, to select all the other site-nav > ul.nav-lists
{%- endcomment -%}

{%- if page.collection == nil -%}

  {%- capture activation_collection_prefix -%}
  .site-nav > ul.nav-list:first-child
  {%- endcapture -%}

  {%- capture activation_other_collection_prefix -%}
  .site-nav > ul.nav-list:not(:first-child)
  {%- endcapture -%}

{%- else -%}

  {%- capture activation_collection_prefix -%}
  .site-nav > ul:nth-of-type({{ nav_index0 }})
  {%- if site.just_the_docs.collections[page.collection].nav_fold %} > li > ul
  {%- endif -%}
  {%- endcapture -%}

  {%- capture activation_other_collection_prefix -%}
  .site-nav > ul:not(:nth-of-type({{ nav_index0 }}))
  {%- endcapture -%}

{%- endif -%}

{%- comment -%}
  The required background image of the link to the current page may involve SCSS.
  To avoid page-dependent SCSS, all nav links initially have that background image.
  The following rule removes the image from the links to all parents, siblings,
  and children of the current page.
{%- endcomment %}

{% if nav_index3 -%}

{{ activation_collection_prefix }} > li > a,
{{ activation_collection_prefix }} > li > ul > li > a,
{{ activation_collection_prefix }} > li > ul > li > ul > li:not(:nth-child({{ nav_index3 }})) > a {
  background-image: none;
}

{%- elsif nav_index2 -%}

{{ activation_collection_prefix }} > li > a,
{{ activation_collection_prefix }} > li > ul > li:not(:nth-child({{ nav_index2 }})) > a,
{{ activation_collection_prefix }} > li > ul > li > ul > li > a {
  background-image: none;
}

{%- else -%}

{{ activation_collection_prefix }} > li:not(:nth-child({{ nav_index1 }})) > a,
{{ activation_collection_prefix }} > li > ul > li > a,
{{ activation_collection_prefix }} > li > ul > li > ul > li > a {
  background-image: none;
}

{%- endif %}

{%- comment -%}
  The following rule removes the image from the links to pages in other collections.
{%- endcomment %}

{{ activation_other_collection_prefix }} a,
.site-nav li.external a {
  background-image: none;
}

{%- comment -%}
  The following rule styles the link to the current page.
{%- endcomment %}

{{ activation_collection_prefix }} > li:nth-child({{ nav_index1 }})
{%- if nav_index2 %} > ul > li:nth-child({{ nav_index2 }})
{%- if nav_index3 %} > ul > li:nth-child({{ nav_index3 }})
{%- endif -%}
{%- endif %} > a {
  font-weight: 600;
  text-decoration: none;
}

{%- comment -%}
  The following rules unfold all collections, and display the links to any children
  of the current page.
  
  To avoid dependence on the SCSS variable nav-list-expander-right, the direction
  of the rotation of the expander icon is fixed, and corresponds to the appearance
  when nav-list-expander-right is true. This results in a minor visual difference
  between the appearance of active expander icons when JS is enabled/disabled and
  nav-list-expander-right is false, which seems unavoidable.
{%- endcomment %}

{%- if site.just_the_docs.collections %}
.site-nav > ul.nav-category-list > li > button svg,
{% endif -%}
{{ activation_collection_prefix }} > li:nth-child({{ nav_index1 }}) > button svg
{%- if nav_index2 -%},
{{ activation_collection_prefix }} > li:nth-child({{ nav_index1 }}) > ul > li:nth-child({{ nav_index2 }}) > button svg
{%- endif %} {
  transform: rotate(-90deg);
}

{%- if site.just_the_docs.collections %}
.site-nav > ul.nav-category-list > li.nav-list-item > ul.nav-list,
{% endif -%}
{{ activation_collection_prefix }} > li.nav-list-item:nth-child({{ nav_index1 }}) > ul.nav-list
{%- if nav_index2 %},
{{ activation_collection_prefix }} > li.nav-list-item:nth-child({{ nav_index1 }}) > ul.nav-list > li.nav-list-item:nth-child({{ nav_index2 }}) > ul.nav-list
{%- endif %} {
  display: block;
}

{%- endif -%}
{%- endif -%}
{%- endif -%}
