{%- comment -%}
  Include as: {%- include components/children_nav.html -%}
  Depends on: page, site, nav_breadcrumbs.
  Results in: HTML for the children-navigation component.
  Issues:
    For sites with more than 3 levels of navigation links, or which use
    `ancestor` fields, the resulting child links are currently incorrect.
  Includes:
    components/nav/sorted.html
    toc_heading_custom.html
  Overwrites:
    nav_ancestor_links, nav_top_node_titles, nav_child_candidates, nav_children,
    nav_child, nav_child_ok, nav_child_ancestor, nav_sorted.
{%- endcomment -%}

{%- comment -%}
  Whether a non-excluded page has any children can be checked efficiently by inspecting
  the site_nav. If the page has no children, nav_children is set to an empty array;
  otherwise nav_children is left unset.
{%- endcomment -%}

{%- assign nav_children = nil -%}

{%- capture nav_list_link -%}
<a href="{{ page.url | relative_url }}" class="nav-list-link">
{%- endcapture -%}

{%- capture site_nav -%}
{%- include_cached components/site_nav.html -%}
{%- endcapture -%}

{%- if site_nav contains nav_list_link -%}

  {%- capture nav_list_simple -%}
  <ul class="nav-list">
  {%- endcapture -%}

  {%- assign nav_child_start = site_nav
        | split: nav_list_link | last
        | split: "</a>" | slice: 1 | first -%}

  {%- assign nav_child_test = nav_child_start 
        | remove_first: nav_list_simple | prepend: nav_list_simple -%}
    
  {%- if nav_child_start != nav_child_test -%}
    {%- assign nav_children = "" | split: "" -%}
  {%- endif -%}

{%- endif -%}

{%- unless nav_children -%}

  {%- comment -%}
    The layout is assumed to include components/breadcrumbs.html before this file,
    otherwise it needs to be included here.
  {%- endcomment -%}

  {%- assign nav_ancestor_links = nav_breadcrumbs | join -%}

  {%- assign nav_top_node_titles = site[page.collection] | default: site.html_pages
        | where_exp:"item", "item.title != nil"
        | where_exp:"item", "item.parent == nil"
        | map: "title" -%}

  {%- assign nav_child_candidates = site[page.collection] | default: site.html_pages
        | where: "parent", page.title -%}

  {%- assign nav_children = "" | split: "" -%}
  {%- for nav_child in nav_child_candidates -%}
    {%- assign nav_child_ok = true -%}

    {%- if nav_child.grand_parent and nav_child.grand_parent != page.parent -%}
      {%- assign nav_child_ok = false -%}
    {%- endif -%}

    {%- if nav_child.ancestor and nav_child.ancestor != page.title -%}
      {%- capture nav_child_ancestor -%} >{{ nav_child.ancestor }}</a> {%- endcapture -%}
      {%- unless nav_ancestor_links contains nav_child_ancestor -%}
        {%- assign nav_child_ok = false -%}
      {%- endunless -%}
    {%- endif -%}

    {%- comment -%}
      The following check rejects nav_child as 3rd-level when page is 2nd-level
      and nav_child can also be 2nd-level. This is for backwards compatibility with
      existing 3-level sites.
    {%- endcomment -%}
    {%- if nav_child.grand_parent == nil and nav_child.ancestor == nil and 
          nav_top_node_titles contains nav_child.parent and nav_breadcrumbs.size >= 1 -%}
      {%- assign nav_child_ok = false -%}
    {%- endif -%}

    {%- if nav_child_ok -%}
      {%- assign nav_children = nav_children | push: nav_child -%}
    {%- endif -%}
  {%- endfor -%}

{%- endunless -%}

{%- if nav_children.size >= 1 -%}

  {%- include components/nav/sorted.html pages=nav_children -%}

  {%- if page.child_nav_order == 'desc' or page.child_nav_order == 'reversed' -%}
    {%- assign nav_sorted = nav_sorted | reverse -%}
  {%- endif -%}

<hr>
{% include toc_heading_custom.html %}
<ul>
  {% for nav_child in nav_sorted %}
  <li>
    <a href="{{ nav_child.url | relative_url }}">{{ nav_child.title }}</a>{% if nav_child.summary %} - {{ nav_child.summary }}{% endif %}
  </li>
  {% endfor %}
</ul>

{%- endif -%}
